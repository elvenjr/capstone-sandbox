name: GitHub Secret Evaluation

on:
  workflow_dispatch:
    inputs:
      assignment_name:
        description: 'Assignment name for evaluation'
        required: false
        default: 'GitHub Secret Assignment'
        type: string

jobs:
   secret-test:
    runs-on: ubuntu-latest
    container:
      image: maniator/gh
    permissions:
      actions: read
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find Assignment Issue
        id: find-issue
        run: |
          echo "Searching for issue with title containing 'GitHub Secret Assignment EVAL'"
          git config --global --add safe.directory $GITHUB_WORKSPACE
          ISSUE_NUMBER=$(gh issue list --state open --limit 100 --json number,title --jq '.[] | select(.title | test("GitHub Secret Assignment EVAL"; "i")) | .number' | head -1)
          if [ ! -z "$ISSUE_NUMBER" ]; then
            echo "✅ Found assignment issue #$ISSUE_NUMBER"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_found=true" >> $GITHUB_OUTPUT
          else
            echo "Creating assignment evaluation issue..."
            NEW_ISSUE_URL=$(gh issue create \
              --title "GitHub Secret Assignment EVAL - GitHub Secrets" \
              --body "This issue is used for tracking GitHub Secret Assignment evaluation results. Comments will be posted here automatically when you run the evaluation workflow.")
            NEW_ISSUE_NUMBER=$(echo "$NEW_ISSUE_URL" | grep -o '[0-9]\+$')
            echo "✅ Created new issue #$NEW_ISSUE_NUMBER"
            echo "issue_number=$NEW_ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_found=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for GitHub Secret
        id: check-secret
        if: steps.find-issue.outputs.issue_found == 'true'
        run: |
          SECRET_EXISTS=false
          SECRET_NAME="ASSIGNMENT_SECRET"
          echo "Checking for GitHub secret: $SECRET_NAME"
          if [ ! -z "${{ secrets.ASSIGNMENT_SECRET }}" ]; then
            SECRET_EXISTS=true
            echo "✅ Secret '$SECRET_NAME' found"
          else
            echo "❌ Secret '$SECRET_NAME' not found"
          fi
          echo "secret_exists=$SECRET_EXISTS" >> $GITHUB_OUTPUT
          echo "secret_name=$SECRET_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ✅ NOVA IMPLEMENTAÇÃO: gerar código direto
      - name: Generate secret code (simplificado)
        id: generate-code
        if: steps.check-secret.outputs.secret_exists == 'true' && steps.find-issue.outputs.issue_found == 'true'
        run: |
          SECRET_CODE="elvenjr-secret-$(date +%s)"
          echo "Generated Secret Code: $SECRET_CODE"
          echo "secret_code=$SECRET_CODE" >> $GITHUB_OUTPUT

      - name: Comment secret code on Issue (Success)
        if: steps.check-secret.outputs.secret_exists == 'true' && steps.find-issue.outputs.issue_found == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find-issue.outputs.issue_number }}
          body: |
            🎉 **GitHub Secret Successfully Configured!** 🎉  
            **Evaluation Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
            **Triggered by:** @${{ github.actor }}  
            **Here's your completion code:**  
            ```
            ${{ steps.generate-code.outputs.secret_code }}
            ```

      - name: Comment on Issue (Secret Not Found)
        if: steps.check-secret.outputs.secret_exists == 'false' && steps.find-issue.outputs.issue_found == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find-issue.outputs.issue_number }}
          body: |
            ⚠️ **GitHub Secret Not Found** ⚠️  
            Please make sure you created a secret called `ASSIGNMENT_SECRET` with any non-empty value in  
            **Settings → Secrets and variables → Actions**  
            Then re-run this workflow again.

      - name: Comment on workflow run (Issue handling)
        if: steps.find-issue.outputs.issue_found == 'false'
        run: |
          echo "❌ Could not find or create assignment issue"
          exit 1
